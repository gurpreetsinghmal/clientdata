<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Clients</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        background: #fafafa;
        font-family: "Roboto", sans-serif;
      }

      .md-card {
        background: #fff;
        border-radius: 16px;
        padding: 28px;
        border: 1px solid #e5eaf0;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      }

      .table-title {
        font-size: 22px;
        font-weight: 500;
        color: #202124;
        margin-bottom: 20px;
      }

      .table thead th {
        background: #f8f9fa;
        font-weight: 500;
        color: #5f6368;
        border-bottom: 2px solid #e8eaed;
        padding: 14px;
      }

      .table tbody tr:hover {
        background: #f1f3f4 !important;
      }

      /* Icon-only buttons styling */
      .dt-buttons {
        display: flex;
        flex-wrap: wrap;
      }

      .dt-buttons .btn-icon {
        border-radius: 50%;
        padding: 6px 10px;
        font-size: 16px;
        background: #f1f3f4;
        border: 1px solid #dadce0;
        
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }

      .dt-buttons .btn-icon:hover {
        background: #e8f0fe;
        opacity: 0.85;
      }

      /* Colored icons */
      .dt-buttons .btn-copy i {
        color: #4285f4;
      } /* blue */
      .dt-buttons .btn-csv i {
        color: #fbbc05;
      } /* yellow/orange */
      .dt-buttons .btn-excel i {
        color: #34a853;
      } /* green */
      .dt-buttons .btn-pdf i {
        color: #ea4335;
      } /* red */
      .dt-buttons .btn-print i {
        color: #5f6368;
      } /* gray */
      .dt-buttons .btn-colvis i {
        color: #1a73e8;
      } /* blue */

      .dt-buttons .btn-icon:last-child {
        margin-right: 0;
      }

      .dataTables_filter input {
        border-radius: 12px !important;
        border: 1px solid #dadce0;
        padding: 6px 12px !important;
      }

      .pagination .page-link {
        border-radius: 50px !important;
        color: #1a73e8;
      }
      .pagination .page-item.active .page-link {
        background: #1a73e8;
        border-color: #1a73e8;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <div class="container py-5">
      <div class="md-card">
        <div class="table-title">Jyoti Dashabord- Client Data</div>

        <table id="googleTable" class="table table-hover" width="100%">
          <thead>
            <tr id="tableHeader"></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <script>
  const sheetID = "1QS9wTP1CdrTspINPeGG56s_VOcB0qMvA19HQpGwFsyg";
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

  $.get(url, function (data) {
    // Remove Google JSON wrapper
    const jsonData = JSON.parse(
      data.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/)[1]
    );

    // Extract columns & rows
    const cols = jsonData.table.cols.map((c) => c.label);
    const rows = jsonData.table.rows.map((r) =>
      r.c.map((cell) => (cell ? cell.v : ""))
    );

    // Add Followup + Action buttons
    cols.push("Followup", "Actions");

    const modifiedRows = rows.map((r) => {
      return [
        ...r,
        "", // followup blank initially
        `<button class="btn btn-sm btn-warning editBtn">Edit</button>
         <button class="btn btn-sm btn-success saveBtn d-none">Save</button>`
      ];
    });

    // Build header
    $("#tableHeader").empty();
    cols.forEach((col) => $("#tableHeader").append(`<th>${col}</th>`));

    // Initialize DataTable
    const table = $("#googleTable").DataTable({
      data: modifiedRows,
      columns: cols.map((c) => ({ title: c })),
      pageLength: 10,
      responsive: true,
    });

    // -----------------------------
    // EDIT BUTTON CLICK
    // -----------------------------
    $("#googleTable tbody").on("click", ".editBtn", function () {
      const row = table.row($(this).closest("tr"));
      const rowData = row.data();

      const followupValue = rowData[rowData.length - 2]; // last second

      rowData[rowData.length - 2] =
        `<input type="text" class="form-control form-control-sm" value="${followupValue}" />`;

      rowData[rowData.length - 1] =
        `<button class="btn btn-sm btn-secondary cancelBtn">Cancel</button>
         <button class="btn btn-sm btn-success saveBtn">Save</button>`;

      row.data(rowData).draw(false);
    });

    // -----------------------------
    // CANCEL BUTTON
    // -----------------------------
    $("#googleTable tbody").on("click", ".cancelBtn", function () {
      const row = table.row($(this).closest("tr"));
      const rowData = row.data();
      
      const value = $(rowData[rowData.length - 2]).val() || "";

      rowData[rowData.length - 2] = value;
      rowData[rowData.length - 1] =
        `<button class="btn btn-sm btn-warning editBtn">Edit</button>
         <button class="btn btn-sm btn-success saveBtn d-none">Save</button>`;

      row.data(rowData).draw(false);
    });

    // -----------------------------
    // SAVE BUTTON â†’ also send to Google Sheets
    // -----------------------------
    $("#googleTable tbody").on("click", ".saveBtn", function () {
      const row = table.row($(this).closest("tr"));
      const rowData = row.data();
console.log(rowData);
      const id = rowData[0]; // ID column
      const newFollowup = $(rowData[rowData.length - 2]).val();

      // TODO: Google Sheet save API here
       //$.post("https://script.google.com/macros/s/AKfycby8J8AVZiYe88qXIj74naHFimw090Ixb2AfV8vaxna4Lsl9uRmNHlH22yW8-CRRCjz9/exec", { id: id, followup: newFollowup });

      $.post(
              "https://script.google.com/macros/s/AKfycby8J8AVZiYe88qXIj74naHFimw090Ixb2AfV8vaxna4Lsl9uRmNHlH22yW8-CRRCjz9/exec",
              JSON.stringify({ id: id, followup: newFollowup }),
              function (res) {
            
                alert("Saved to Google Sheet");
              }
            );

      rowData[rowData.length - 2] = newFollowup;
      rowData[rowData.length - 1] =
        `<button class="btn btn-sm btn-warning editBtn">Edit</button>
         <button class="btn btn-sm btn-success saveBtn d-none">Save</button>`;

      row.data(rowData).draw(false);
    });
  });
</script>

  </body>
</html>
